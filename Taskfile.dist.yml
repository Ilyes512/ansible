version: "3"

silent: true

vars:
  DOCKER_REGISTRY_HOST: ghcr.io
  DOCKER_REGISTRY_PATH: ilyes512/ansible
  DOCKER_HADOLINT_IMAGE_TAG: v2.10.0
  DOCKER_UTILS_IMAGE_TAG: 1.1.0

includes:
  act:
    taskfile: ./act
    dir: ./act

tasks:

  run-script:
    preconditions:
      - sh: test "{{.RUN_SCRIPT}}" != ""
        msg: RUN_SCRIPT was not given!
    cmds:
      - cmd: docker run
             --interactive
             --tty
             --rm
             --volume $(pwd):/workdir
             --workdir /workdir
             ghcr.io/ilyes512/utils:{{.DOCKER_UTILS_IMAGE_TAG}}
             /bin/bash -c ./scripts/{{.RUN_SCRIPT}}
        ignore_error: true

  check-versions:
    desc: Check kubctl and kubectx versions
    output: group
    deps:
      - task: run-script
        vars:
          RUN_SCRIPT: check_kubectl.sh
      - task: run-script
        vars:
          RUN_SCRIPT: check_kubectx.sh
      - task: run-script
        vars:
          RUN_SCRIPT: check_kubens.sh
      - task: run-script
        vars:
          RUN_SCRIPT: check_helm.sh

  build:
    desc: Build and run new.Dockerfile
    cmds:
      - docker build
        --tag {{.DOCKER_REGISTRY_HOST}}/{{.DOCKER_REGISTRY_PATH}}:latest
        --target ansible
        .
      - docker build
        --tag {{.DOCKER_REGISTRY_HOST}}/{{.DOCKER_REGISTRY_PATH}}:k8s-latest
        --target k8s
        .

  requirements:
    desc: Update requirements.txt file
    cmds:
      - docker build
        --tag {{.DOCKER_REGISTRY_HOST}}/{{.DOCKER_REGISTRY_PATH}}:requirements-latest
        --file requirements.Dockerfile
        --no-cache
        .
      - docker run --rm --tty {{.DOCKER_REGISTRY_HOST}}/{{.DOCKER_REGISTRY_PATH}}:requirements-latest > requirements.txt
      - docker rmi {{.DOCKER_REGISTRY_HOST}}/{{.DOCKER_REGISTRY_PATH}}:requirements-latest

  lint:
    desc: Apply a Dockerfile linter (https://github.com/hadolint/hadolint)
    cmds:
      - docker run
        --interactive
        --rm
        --volume $(pwd)/.hadolint.yml:/.hadolint.yml
        hadolint/hadolint:{{.DOCKER_HADOLINT_IMAGE_TAG}}
        hadolint
        -
        < Dockerfile

  a:shell:
    desc: Interactive shell with Ansible
    interactive: true
    cmds:
      - docker run
        --interactive
        --tty
        --rm
        --user $(id -u):$(id -g)
        --volume $(pwd):/ansible
        --env ANSIBLE_CONFIG="/ansible/ansible"
        {{.DOCKER_REGISTRY_HOST}}/{{.DOCKER_REGISTRY_PATH}}:latest
